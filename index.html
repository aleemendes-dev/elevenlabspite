<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agente PITE</title>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }

    body{
      min-height: 100vh;
      font-family: Arial, Helvetica, sans-serif;

      background-image: url("Tadayuki.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    /* Overlay sem roubar clique */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.10);
      pointer-events: none;
    }

    /* Avatar (GIF) no canto inferior direito */
    #piteAvatar {
      position: fixed;
      right: 24px;
      bottom: 170px; /* fica acima do widget */
      width: 170px;
      height: auto;
      z-index: 2147483646;
      pointer-events: none; /* não atrapalha clique no widget */
      user-select: none;
      -webkit-user-drag: none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.25));
    }

    /* Widget no canto */
    elevenlabs-convai{
      position: fixed !important;
      right: 24px;
      bottom: 24px;
      z-index: 2147483647;
      display: block !important;

      min-width: 340px;
      min-height: 120px;

      pointer-events: auto;
    }

    @media (max-width: 480px){
      #piteAvatar{
        right: 12px;
        bottom: 155px;
        width: 140px;
      }

      elevenlabs-convai{
        right: 12px;
        bottom: 12px;
        min-width: 280px;
      }
    }
  </style>
</head>

<body>

  <!-- Avatar: parado (piscando) por padrão -->
  <img id="piteAvatar" src="pitepiscando.gif" alt="Avatar PITE" />

  <elevenlabs-convai agent-id="agent_7501kc0b1hvaeymt039z1862ym4f"></elevenlabs-convai>

  <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" defer></script>

  <script>
    // Arquivos
    const GIF_FALANDO = "pitebocaberta.gif";
    const GIF_PARADO  = "piteestatico.jpeg";

    // Ajuste fino
    const LIMIAR_VOLUME = 22;   // aumenta se estiver trocando por barulho; diminui se não ativar
    const HOLD_MS = 400;        // mantém "falando" um pouco após o som cair (evita piscar)

    const avatar = document.getElementById("piteAvatar");

    let audioContext, analyser, dataArray;
    let iniciado = false;
    let falando = false;
    let ultimoSomEm = 0;

    function setAvatarFalando(isFalando){
      if (isFalando === falando) return;
      falando = isFalando;
      avatar.src = falando ? GIF_FALANDO : GIF_PARADO;
    }

    async function iniciarDeteccaoAudio(){
      if (iniciado) return;
      iniciado = true;

      try {
        // precisa de interação do usuário (o clique no widget serve)
        audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Captura mic (mesma permissão que o agente usa)
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioContext.createMediaStreamSource(stream);

        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;

        source.connect(analyser);
        dataArray = new Uint8Array(analyser.frequencyBinCount);

        monitorarVolume();
      } catch (err) {
        console.error("Não foi possível iniciar detecção de áudio:", err);
        // Se não tiver permissão, deixa parado
        setAvatarFalando(false);
      }
    }

    function monitorarVolume(){
      analyser.getByteFrequencyData(dataArray);

      // média simples do espectro
      let soma = 0;
      for (let i = 0; i < dataArray.length; i++) soma += dataArray[i];
      const volume = soma / dataArray.length;

      const agora = Date.now();

      if (volume > LIMIAR_VOLUME) {
        ultimoSomEm = agora;
        setAvatarFalando(true);
      } else {
        // segura um pouco para não ficar trocando rápido
        if (falando && (agora - ultimoSomEm) > HOLD_MS) {
          setAvatarFalando(false);
        }
      }

      requestAnimationFrame(monitorarVolume);
    }

    // Usa clique em qualquer lugar da página (inclui o widget) como gatilho
    // Se quiser ser mais restrito: só iniciar quando clicar no widget.
    document.addEventListener("click", () => {
      iniciarDeteccaoAudio();
    }, { once: true });

    // (Opcional) Se você quiser iniciar SOMENTE quando clicar no widget:
    // document.addEventListener("click", (e) => {
    //   if (e.target.closest("elevenlabs-convai")) iniciarDeteccaoAudio();
    // }, { once: true });
  </script>

</body>
</html>
