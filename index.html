<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agente PITE</title>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }

    body{
      min-height: 100vh;
      font-family: Arial, Helvetica, sans-serif;
      background-image: url("Tadayuki.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.10);
      pointer-events: none;
    }

    /* Avatar ‚Äì canto superior direito */
    #piteAvatar {
      position: fixed;
      top: 24px;
      right: 24px;
      width: 170px;
      height: auto;
      z-index: 2147483000;
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.25));
    }

    /* Bot√£o: sempre acima de tudo */
    #btnAudioAba {
      position: fixed;
      top: 24px;
      left: 24px;
      z-index: 9999999999; /* acima de qualquer iframe/widget */
      padding: 10px 14px;
      border: 0;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 10px 18px rgba(0,0,0,0.15);
      pointer-events: auto !important;
      -webkit-tap-highlight-color: transparent;
    }
    #btnAudioAba small{
      display:block;
      font-weight: 400;
      margin-top: 4px;
      opacity: .75;
    }

    elevenlabs-convai{
      position: fixed !important;
      right: 24px;
      bottom: 24px;
      z-index: 2147482000;
      display: block !important;
      min-width: 340px;
      min-height: 120px;
      pointer-events: auto;
    }

    @media (max-width: 480px){
      #piteAvatar{ top: 12px; right: 12px; width: 140px; }
      #btnAudioAba{ top: 12px; left: 12px; padding: 10px 12px; }
      elevenlabs-convai{ right: 12px; bottom: 12px; min-width: 280px; }
    }

    /* v√≠deo oculto (mant√©m stream vivo em alguns browsers) */
    #hiddenVideo {
      position: fixed;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
      left: -9999px;
      top: -9999px;
    }
  </style>
</head>

<body>
  <img id="piteAvatar" src="pitepiscando.gif" alt="Avatar PITE" />

  <button id="btnAudioAba" type="button">
    üéß Ativar detec√ß√£o do √°udio da aba
    <small>Selecione ‚ÄúEsta guia‚Äù e marque ‚ÄúCompartilhar √°udio‚Äù.</small>
  </button>

  <elevenlabs-convai agent-id="agent_7501kc0b1hvaeymt039z1862ym4f"></elevenlabs-convai>
  <video id="hiddenVideo" muted playsinline></video>

  <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" defer></script>

  <script>
    const GIF_FALANDO = "pitebocaberta.gif";
    const GIF_PARADO  = "pitepiscando.gif";

    const LIMIAR_VOLUME = 18;
    const HOLD_MS = 450;

    const avatar = document.getElementById("piteAvatar");
    const btn = document.getElementById("btnAudioAba");
    const hiddenVideo = document.getElementById("hiddenVideo");

    let audioContext, analyser, dataArray;
    let falando = false;
    let ultimoSomEm = 0;

    // estado da captura
    let streamAtual = null;
    let rodando = false;

    function setAvatarFalando(isFalando){
      if (isFalando === falando) return;
      falando = isFalando;
      avatar.src = falando ? GIF_FALANDO : GIF_PARADO;
    }

    function atualizarBotao(){
      if (rodando) {
        btn.innerHTML = `‚õî Parar detec√ß√£o (√°udio da aba)
          <small>Clique para encerrar o compartilhamento.</small>`;
      } else {
        btn.innerHTML = `üéß Ativar detec√ß√£o do √°udio da aba
          <small>Selecione ‚ÄúEsta guia‚Äù e marque ‚ÄúCompartilhar √°udio‚Äù.</small>`;
      }
    }

    function pararCaptura(){
      rodando = false;
      setAvatarFalando(false);

      if (streamAtual) {
        streamAtual.getTracks().forEach(t => t.stop());
        streamAtual = null;
      }
      if (audioContext) {
        try { audioContext.close(); } catch(e) {}
        audioContext = null;
      }
      analyser = null;
      dataArray = null;

      hiddenVideo.srcObject = null;
      atualizarBotao();
    }

    function monitorarVolume(){
      if (!rodando || !analyser) return;

      analyser.getByteFrequencyData(dataArray);

      let soma = 0;
      for (let i = 0; i < dataArray.length; i++) soma += dataArray[i];
      const volume = soma / dataArray.length;

      const agora = Date.now();

      if (volume > LIMIAR_VOLUME) {
        ultimoSomEm = agora;
        setAvatarFalando(true);
      } else if (falando && (agora - ultimoSomEm) > HOLD_MS) {
        setAvatarFalando(false);
      }

      requestAnimationFrame(monitorarVolume);
    }

    async function iniciarCapturaDaAba(){
      // toggle: se j√° est√° rodando, para
      if (rodando) {
        pararCaptura();
        return;
      }

      try {
        // ‚úÖ pedir VIDEO + AUDIO aumenta a chance de liberar ‚Äú√°udio da guia‚Äù
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: true,
          audio: true
        });

        // se n√£o veio √°udio, n√£o serve
        if (!stream.getAudioTracks() || stream.getAudioTracks().length === 0) {
          stream.getTracks().forEach(t => t.stop());
          alert("Voc√™ compartilhou sem √°udio. Selecione ‚ÄúEsta guia‚Äù e marque ‚ÄúCompartilhar √°udio‚Äù.");
          return;
        }

        streamAtual = stream;

        // manter stream vivo
        hiddenVideo.srcObject = stream;
        hiddenVideo.play().catch(() => {});

        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);

        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;
        source.connect(analyser);

        dataArray = new Uint8Array(analyser.frequencyBinCount);

        // se o usu√°rio parar o compartilhamento na UI do browser
        stream.getTracks().forEach(track => {
          track.onended = () => {
            pararCaptura();
          };
        });

        rodando = true;
        atualizarBotao();
        monitorarVolume();

      } catch (err) {
        console.error("Falha ao capturar √°udio da aba:", err);
        alert(
          "N√£o foi poss√≠vel capturar o √°udio da aba.\n\n" +
          "‚úÖ Use Chrome/Edge no computador.\n" +
          "‚úÖ Selecione ‚ÄúEsta guia‚Äù.\n" +
          "‚úÖ Marque ‚ÄúCompartilhar √°udio‚Äù."
        );
      }
    }

    atualizarBotao();
    btn.addEventListener("click", iniciarCapturaDaAba);
  </script>
</body>
</html>
