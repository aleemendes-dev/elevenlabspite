<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agente PITE</title>

  <style>
    html, body { margin: 0; padding: 0; height: 100%; }

    body{
      min-height: 100vh;
      font-family: Arial, Helvetica, sans-serif;
      background-image: url("Tadayuki.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.10);
      pointer-events: none;
    }

    /* Avatar ‚Äì canto superior direito */
    #piteAvatar {
      position: fixed;
      top: 24px;
      right: 24px;
      width: 170px;
      height: auto;
      z-index: 2147483646;
      pointer-events: none;
      user-select: none;
      -webkit-user-drag: none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.25));
    }

    /* Bot√£o */
    #btnAudioAba {
      position: fixed;
      top: 24px;
      left: 24px;
      z-index: 2147483647;
      padding: 10px 14px;
      border: 0;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      background: rgba(255,255,255,0.92);
      box-shadow: 0 10px 18px rgba(0,0,0,0.15);
    }
    #btnAudioAba small{
      display:block;
      font-weight: 400;
      margin-top: 4px;
      opacity: .75;
    }

    /* Widget ‚Äì canto inferior direito */
    elevenlabs-convai{
      position: fixed !important;
      right: 24px;
      bottom: 24px;
      z-index: 2147483647;
      display: block !important;
      min-width: 340px;
      min-height: 120px;
      pointer-events: auto;
    }

    @media (max-width: 480px){
      #piteAvatar{ top: 12px; right: 12px; width: 140px; }
      #btnAudioAba{ top: 12px; left: 12px; padding: 10px 12px; }
      elevenlabs-convai{ right: 12px; bottom: 12px; min-width: 280px; }
    }

    /* (opcional) v√≠deo oculto, s√≥ pra manter permiss√µes est√°veis em alguns browsers */
    #hiddenVideo {
      position: fixed;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
      left: -9999px;
      top: -9999px;
    }
  </style>
</head>

<body>
  <img id="piteAvatar" src="pitepiscando.gif" alt="Avatar PITE" />

  <button id="btnAudioAba" type="button">
    üéß Ativar detec√ß√£o do √°udio da aba
    <small>Escolha ‚ÄúEsta guia‚Äù e marque ‚ÄúCompartilhar √°udio‚Äù.</small>
  </button>

  <elevenlabs-convai agent-id="agent_7501kc0b1hvaeymt039z1862ym4f"></elevenlabs-convai>

  <video id="hiddenVideo" muted playsinline></video>

  <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" defer></script>

  <script>
    const GIF_FALANDO = "pitebocaberta.gif";
    const GIF_PARADO  = "pitepiscando.gif";

    const LIMIAR_VOLUME = 18;
    const HOLD_MS = 450;

    const avatar = document.getElementById("piteAvatar");
    const btn = document.getElementById("btnAudioAba");
    const hiddenVideo = document.getElementById("hiddenVideo");

    let audioContext, analyser, dataArray;
    let falando = false;
    let ultimoSomEm = 0;
    let iniciado = false;

    function setAvatarFalando(isFalando){
      if (isFalando === falando) return;
      falando = isFalando;
      avatar.src = falando ? GIF_FALANDO : GIF_PARADO;
    }

    function monitorarVolume(){
      if (!analyser) return;

      analyser.getByteFrequencyData(dataArray);

      let soma = 0;
      for (let i = 0; i < dataArray.length; i++) soma += dataArray[i];
      const volume = soma / dataArray.length;

      const agora = Date.now();

      if (volume > LIMIAR_VOLUME) {
        ultimoSomEm = agora;
        setAvatarFalando(true);
      } else if (falando && (agora - ultimoSomEm) > HOLD_MS) {
        setAvatarFalando(false);
      }

      requestAnimationFrame(monitorarVolume);
    }

    async function iniciarCapturaDaAba(){
      if (iniciado) return;
      iniciado = true;

      try {
        // ‚úÖ Importante: pedir VIDEO + AUDIO (Chrome/Edge costumam exigir isso para liberar √°udio da guia)
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: true,
          audio: true
        });

        // Alguns browsers s√≥ liberam √°udio se o usu√°rio marcar ‚ÄúCompartilhar √°udio‚Äù
        if (!stream.getAudioTracks() || stream.getAudioTracks().length === 0) {
          stream.getTracks().forEach(t => t.stop());
          iniciado = false;
          alert("Voc√™ compartilhou sem √°udio. Selecione ‚ÄúEsta guia‚Äù e marque ‚ÄúCompartilhar √°udio‚Äù.");
          return;
        }

        // (Opcional) manter o stream ‚Äúvivo‚Äù associando a um v√≠deo oculto
        hiddenVideo.srcObject = stream;
        hiddenVideo.play().catch(() => {});

        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);

        analyser = audioContext.createAnalyser();
        analyser.fftSize = 512;
        source.connect(analyser);

        dataArray = new Uint8Array(analyser.frequencyBinCount);

        // Se parar de compartilhar, resetar
        stream.getTracks().forEach(track => {
          track.onended = () => {
            iniciado = false;
            setAvatarFalando(false);
            btn.disabled = false;
            btn.innerHTML = `üéß Ativar detec√ß√£o do √°udio da aba
              <small>Escolha ‚ÄúEsta guia‚Äù e marque ‚ÄúCompartilhar √°udio‚Äù.</small>`;
          };
        });

        btn.disabled = true;
        btn.textContent = "‚úÖ Detec√ß√£o ativa (√°udio da aba)";
        monitorarVolume();

      } catch (err) {
        iniciado = false;
        console.error("Falha ao capturar √°udio da aba:", err);

        // Mensagem mais objetiva (sem aquele alerta gen√©rico)
        alert(
          "N√£o foi poss√≠vel capturar o √°udio da aba.\n\n" +
          "‚úÖ Use Chrome/Edge no computador.\n" +
          "‚úÖ Clique no bot√£o e selecione ‚ÄúEsta guia‚Äù.\n" +
          "‚úÖ Marque ‚ÄúCompartilhar √°udio‚Äù."
        );
      }
    }

    btn.addEventListener("click", iniciarCapturaDaAba);
  </script>
</body>
</html>
